<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø§Ù„ÙÙ‡Ù… Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠ Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ | Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b34cc; --stroke:#ffffff1f;
      --text:#eef3ff; --muted:#b7c3e6;
      --accent:#7c5cff; --good:#22c55e; --bad:#ef4444;
      --shadow:0 18px 50px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Tajawal","Cairo",system-ui,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.18), transparent 60%),
        linear-gradient(180deg, #070b14, var(--bg));
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.75), rgba(11,18,32,.25));
      border-bottom:1px solid var(--stroke);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,197,94,.75));border:1px solid rgba(255,255,255,.18);box-shadow:0 12px 30px rgba(124,92,255,.22)}
    h1{margin:0;font-size:15px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--stroke);background:rgba(255,255,255,.06);border-radius:999px;padding:10px 12px;font-size:12px;color:var(--muted)}
    .pill b{color:var(--text)}
    .btn{
      border:1px solid var(--stroke); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:999px; cursor:pointer;
      font-weight:800; font-size:12px;
    }
    .btn.primary{background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.55));border-color:rgba(124,92,255,.45)}
    .btn.good{background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.55));border-color:rgba(34,197,94,.45)}
    .btn.bad{background:linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));border-color:rgba(239,68,68,.45)}
    .grid{display:grid;grid-template-columns: 360px 1fr;gap:14px;margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .bd{padding:16px}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input,select{
      width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    .story{border:1px dashed rgba(255,255,255,.18);background:rgba(255,255,255,.04);border-radius:16px;padding:14px;line-height:1.9;white-space:pre-wrap}
    .q{margin-top:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.05);border-radius:16px;padding:14px}
    .q h3{margin:0 0 10px;font-size:13px}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);cursor:pointer}
    .opt:hover{border-color:rgba(255,255,255,.25)}
    .opt.good{border-color:rgba(34,197,94,.65);background:rgba(34,197,94,.12)}
    .opt.bad{border-color:rgba(239,68,68,.65);background:rgba(239,68,68,.12)}
    .bullet{width:22px;height:22px;border-radius:999px;border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;font-weight:900;font-size:12px;margin-top:2px}
    .muted{color:var(--muted)}
    .toast{position:fixed;right:16px;bottom:16px;z-index:50;display:none;
      max-width:min(420px, calc(100vw - 32px));
      padding:12px 14px;border-radius:16px;border:1px solid var(--stroke);
      background:rgba(12,18,34,.88);backdrop-filter: blur(10px);box-shadow:var(--shadow)}
    .toast.show{display:block}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px 8px;text-align:right;vertical-align:top}
    th{color:var(--muted);font-weight:800}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);cursor:pointer;font-weight:800;font-size:12px}
    .tab.active{border-color:rgba(124,92,255,.55);background:rgba(124,92,255,.14)}
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Ø§Ù„ÙÙ‡Ù… Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠ Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</h1>
        <div class="sub">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø©: Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
      </div>
    </div>
    <div class="right">
      <div class="pill">Ø§Ù„Ø²ÙˆØ§Ø±: <b id="visits">â€”</b></div>
      <button class="btn" id="btnStudent">ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</button>
      <button class="btn primary" id="btnAdmin">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª -->
    <section class="card" id="studentPanel">
      <div class="hd">
        <b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</b>
        <span class="muted" id="today">â€”</span>
      </div>
      <div class="bd">
        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø© (Ø«Ù„Ø§Ø«ÙŠ)</label>
        <input id="studentName" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ"/>

        <div class="row">
          <div>
            <label>Ø§Ù„Ø¯Ø±Ø³</label>
            <select id="lessonSelect"></select>
          </div>
          <div>
            <label>Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</label>
            <input id="studentLink" readonly/>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn good" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø³</button>
          <button class="btn" id="saveBtn" disabled>Ø§Ø¹ØªÙ…Ø§Ø¯ + Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
          <button class="btn bad" id="clearBtn" disabled>Ù…Ø³Ø­ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³</button>
        </div>

        <div style="margin-top:12px" class="muted">
          âœ… ÙŠØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§Øª ÙƒÙ„ Ø³Ø¤Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø¬Ù‡Ø§Ø² Ø§Ù„Ø·Ø§Ù„Ø¨Ø©.<br/>
          âœ… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ (Ø¯Ø®ÙˆÙ„ + Ù†ØªÙŠØ¬Ø©) Ø¥Ù„Ù‰ Google Sheet Ù„Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.
        </div>
      </div>
    </section>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³ -->
    <section class="card" id="lessonPanel">
      <div class="hd">
        <b id="lessonTitle">â€”</b>
        <span class="muted">Ø§Ù„Ù†Ù‚Ø§Ø·: <b id="pts">0</b> / <b id="maxPts">0</b></span>
      </div>
      <div class="bd">
        <div class="story" id="story">Ø§Ø®ØªØ§Ø±ÙŠ Ø¯Ø±Ø³Ù‹Ø§ Ø«Ù… Ø§Ø¶ØºØ·ÙŠ (Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø³).</div>
        <div id="questions"></div>
      </div>
    </section>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <section class="card" id="adminPanel" style="display:none; grid-column:1/-1">
      <div class="hd">
        <b>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</b>
        <div class="tabs">
          <div class="tab active" data-tab="results">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
          <div class="tab" data-tab="logins">Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label>Ø±Ù‚Ù… Ø³Ø±ÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
            <input id="adminPin" type="password" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ"/>
          </div>
          <div>
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ø§</label>
            <input id="adminLimit" type="number" value="200" min="20" max="500"/>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn primary" id="loadAdmin">Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="btn" id="closeAdmin">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>

        <div style="margin-top:14px" class="muted">
          Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ÙˆÙ†ØªØ§Ø¦Ø¬ ÙƒÙ„ Ø¯Ø±Ø³ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Sheet.
        </div>

        <div id="adminTable" style="margin-top:14px"></div>
      </div>
    </section>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===============================
   âœ… 1) Ø±Ø§Ø¨Ø· GAS Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„ØªÙŠÙ‡)
================================ */
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbznaXBg9dlbwXDlCQIW9b6b-0Hnin9foReBdUpkPFHjjGbz_5gk24WQmG8SgtulF8Oh/exec";
const SITE_KEY = "READING_SCIENCE_G6";

/* ===============================
   2) Ø¯Ø±ÙˆØ³ (Ù…Ø«Ø§Ù„ÙŠÙ† â€” Ø¥Ø°Ø§ ØªØ¨ØºÙŠÙ† Ø£Ø¯Ù…Ø¬ ÙƒÙ„ Ø¯Ø±ÙˆØ³Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£Ø±Ø³Ù„ÙŠ Ù…Ù„Ù index Ø§Ù„Ù‚Ø¯ÙŠÙ…)
================================ */
const LESSONS = [
  {
    id:"foodchains",
    title:"Ø§Ù„Ø³Ù„Ø§Ø³Ù„ ÙˆØ§Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ÙˆÙ‡Ø±Ù… Ø§Ù„Ø·Ø§Ù‚Ø©",
    story:`ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙƒØ§Ù† Ø®Ø§Ù„Ø¯ ÙŠÙ„Ø§Ø­Ø¸ ÙÙŠ Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ¬ÙˆØ¯ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø¬Ø±Ø§Ø¯...`,
    questions:[
      {q:"Ù…Ø§ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ Ù„Ø§Ø­Ø¸Ù‡Ø§ Ø®Ø§Ù„Ø¯ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ", opts:["Ù†Ù‚Øµ Ø§Ù„Ù…Ø§Ø¡","Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø¬Ø±Ø§Ø¯ ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©","Ù†Ù…Ùˆ Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª Ø¨Ø³Ø±Ø¹Ø©","Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø¶ÙØ§Ø¯Ø¹"], a:1},
      {q:"Ù…Ø§ Ø§Ù„ÙØ±Ø¶ÙŠØ© Ø§Ù„ØªÙŠ ÙˆØ¶Ø¹Ù‡Ø§ Ø®Ø§Ù„Ø¯ØŸ", opts:["Ø§Ù„Ø¬Ø±Ø§Ø¯ ÙŠØ­Ø¨ Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ø±","Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª Ù…Ø±ÙŠØ¶Ø©","ØºÙŠØ§Ø¨ Ø§Ù„Ø¶ÙØ§Ø¯Ø¹ Ø³Ø¨Ø¨ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¬Ø±Ø§Ø¯","Ø§Ù„Ù…Ø§Ø¡ ØºÙŠØ± ÙƒØ§Ù"], a:2},
      {q:"Ù…Ø§ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙŠ Ù‚Ø§Ù… Ø¨Ù‡Ø§ØŸ", opts:["Ø±ÙŠ Ù…Ø®ØªÙ„Ù","Ù‚ÙŠØ§Ø³ Ø­Ø±Ø§Ø±Ø©","ØªØºÙŠÙŠØ± ØªØ±Ø¨Ø©","Ø­ÙˆØ¶ Ø¨Ø¶ÙØ§Ø¯Ø¹ ÙˆØ¢Ø®Ø± Ø¨Ø¯ÙˆÙ†"], a:3},
      {q:"Ù…Ø§ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ", opts:["Ù†Ù…Øª Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª Ø£ÙØ¶Ù„ Ù…Ø¹ Ø§Ù„Ø¶ÙØ§Ø¯Ø¹","Ø²Ø§Ø¯ Ø§Ù„Ø¬Ø±Ø§Ø¯ Ù…Ø¹ Ø§Ù„Ø¶ÙØ§Ø¯Ø¹","Ø£ÙƒÙ„Øª Ø§Ù„Ø¶ÙØ§Ø¯Ø¹ Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª","Ù„Ù… ØªÙ†Ù…Ù"], a:0},
      {q:"Ù…Ø§ Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ØŸ", opts:["ØªØºÙŠÙŠØ± Ø§Ù„ØªØ±Ø¨Ø©","ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¶ÙØ§Ø¯Ø¹ ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø²Ù†","Ø§Ù„Ø¬Ø±Ø§Ø¯ Ù…ÙÙŠØ¯","Ø³Ù‚ÙŠ Ø£ÙƒØ«Ø±"], a:1},
    ]
  },
  {
    id:"ecosystems",
    title:"Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©",
    story:`Ù‚Ø§Ù…Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¥Ø­Ø¶Ø§Ø± ØµÙˆØ± Ù„ØºØ§Ø¨ØªÙŠÙ† Ù…Ø®ØªÙ„ÙØªÙŠÙ†...`,
    questions:[
      {q:"Ù…Ø§ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ø§Ù„ØªÙŠ Ù„Ø§Ø­Ø¸ØªÙ‡Ø§ Ø³Ø§Ø±Ø©ØŸ", opts:["Ù‚Ù„Ø© Ø§Ù„Ø£Ù…Ø·Ø§Ø±","Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª","ØªØ´Ø§Ø¨Ù‡ Ø§Ù„ØªØ±Ø¨Ø©","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª"], a:1},
      {q:"Ù…Ø§ Ø§Ù„ÙØ±Ø¶ÙŠØ©ØŸ", opts:["Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù†ÙØ³Ù‡Ø§","Ø¹Ø´ÙˆØ§Ø¦ÙŠ","Ø§Ù„Ù…Ù†Ø§Ø® ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©","Ø§Ù„ØªØ±Ø¨Ø© Ù†ÙØ³Ù‡Ø§"], a:2},
      {q:"Ù…Ø§ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ", opts:["Ø£Ø·ÙˆØ§Ù„ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±","Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª","Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ù‡Ø§Ø±","Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ù„Ø±Ø·ÙˆØ¨Ø©"], a:3},
      {q:"Ù…Ø§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ", opts:["Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ù„Ø±Ø·ÙˆØ¨Ø©","ØªØµÙˆÙŠØ±","Ø±Ø³Ù…","Ù‚ØµØ©"], a:0},
      {q:"Ø§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ØŸ", opts:["Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù…Ø§Ø¡","Ø§Ù„Ù…Ù†Ø§Ø® Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù","ÙƒÙ„ Ø§Ù„ØºØ§Ø¨Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø©","Ø§Ù„ØªØ±Ø¨Ø© Ù„Ø§ ØªØ¤Ø«Ø±"], a:1},
    ]
  }
];

const $ = s => document.querySelector(s);
function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>t.classList.remove("show"), 2400);
}

/* ===============================
   3) doPost JSON Ø®Ø§Ù… (Ø¨Ø¯ÙˆÙ† CORS)
================================ */
function postJSON(obj){
  const payload = JSON.stringify(obj);
  if(navigator.sendBeacon){
    try{ navigator.sendBeacon(GAS_ENDPOINT, payload); return Promise.resolve(true); }catch(e){}
  }
  return fetch(GAS_ENDPOINT, {method:"POST", mode:"no-cors", body: payload})
    .then(()=>true).catch(()=>false);
}

/* ===============================
   4) doGet JSONP (Ù„Ù„Ø¹Ø¯Ø§Ø¯ + Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©) â€” ÙŠØ­ØªØ§Ø¬ doGet ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
================================ */
function loadJSONP(params, callback){
  const cb = "cb_" + Math.random().toString(16).slice(2);
  window[cb] = (data)=>{
    try{ callback(data); } finally {
      delete window[cb];
      script.remove();
    }
  };
  params.callback = cb;
  const qs = new URLSearchParams(params).toString();
  const script = document.createElement("script");
  script.src = GAS_ENDPOINT + "?" + qs;
  document.body.appendChild(script);
}

/* ===============================
   5) Ø­ÙØ¸ Ù…ØªØµÙØ­ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© (Ø¥Ø¬Ø§Ø¨Ø§Øª)
================================ */
function keyProgress(student, lessonId){
  return `G6_READ_${student}_${lessonId}`;
}
function saveProgress(student, lessonId, answers){
  localStorage.setItem(keyProgress(student, lessonId), JSON.stringify(answers));
}
function loadProgress(student, lessonId){
  try{ return JSON.parse(localStorage.getItem(keyProgress(student, lessonId)) || "null"); }
  catch{ return null; }
}
function clearProgress(student, lessonId){
  localStorage.removeItem(keyProgress(student, lessonId));
}

/* ===============================
   6) Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø³
================================ */
const state = { lesson:null, answers:[], points:0 };

function fillLessons(){
  const sel = $("#lessonSelect");
  sel.innerHTML = "";
  LESSONS.forEach(L=>{
    const op = document.createElement("option");
    op.value = L.id; op.textContent = L.title;
    sel.appendChild(op);
  });
}
function updateStudentLink(){
  const name = $("#studentName").value.trim();
  const lessonId = $("#lessonSelect").value;
  const url = new URL(location.href);
  url.searchParams.set("student", name || "");
  url.searchParams.set("lesson", lessonId || "");
  $("#studentLink").value = url.toString();
}
$("#studentName").addEventListener("input", updateStudentLink);
$("#lessonSelect").addEventListener("change", updateStudentLink);

function renderLesson(student, lesson){
  state.lesson = lesson;
  state.answers = lesson.questions.map(()=>({selected:null, correct:false}));
  state.points = 0;

  $("#lessonTitle").textContent = lesson.title;
  $("#story").textContent = lesson.story;
  $("#maxPts").textContent = String(lesson.questions.length);
  $("#pts").textContent = "0";

  const qs = $("#questions");
  qs.innerHTML = "";

  const saved = loadProgress(student, lesson.id);
  if(saved && Array.isArray(saved)){
    saved.forEach((sel, i)=>{
      if(typeof sel === "number"){
        state.answers[i].selected = sel;
        state.answers[i].correct = (sel === lesson.questions[i].a);
      }
    });
    state.points = state.answers.filter(a=>a.correct).length;
    $("#pts").textContent = String(state.points);
  }

  lesson.questions.forEach((qq, idx)=>{
    const box = document.createElement("div");
    box.className = "q";
    box.innerHTML = `<h3>${idx+1}) ${qq.q}</h3>`;
    const opts = document.createElement("div");

    qq.opts.forEach((txt, oi)=>{
      const opt = document.createElement("div");
      opt.className = "opt";
      opt.innerHTML = `<div class="bullet">${String.fromCharCode(65+oi)}</div><div>${txt}</div>`;

      if(state.answers[idx].selected === oi){
        opt.classList.add(oi === qq.a ? "good" : "bad");
      }

      opt.addEventListener("click", ()=>{
        Array.from(opts.children).forEach(ch=>ch.classList.remove("good","bad"));

        state.answers[idx].selected = oi;
        const ok = (oi === qq.a);
        state.answers[idx].correct = ok;
        opt.classList.add(ok ? "good" : "bad");

        state.points = state.answers.filter(a=>a.correct).length;
        $("#pts").textContent = String(state.points);

        // âœ… Ø­ÙØ¸ ÙÙˆØ±ÙŠ ÙÙŠ Ù…ØªØµÙØ­ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©
        saveProgress(student, lesson.id, state.answers.map(a=>a.selected));

        $("#saveBtn").disabled = false;
        $("#clearBtn").disabled = false;

        // ØµÙˆØª Ø®Ø·Ø£ Ø¨Ø³ÙŠØ· (Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª)
        if(!ok){
          try{
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.type="square"; o.frequency.value=220; g.gain.value=0.06;
            o.connect(g); g.connect(ctx.destination);
            o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 150);
          }catch(e){}
        }

        toast(ok ? "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©" : "ğŸ”” Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©.. Ø¹Ø¯Ù‘Ù„ÙŠÙ‡Ø§");
      });

      opts.appendChild(opt);
    });

    box.appendChild(opts);
    qs.appendChild(box);
  });

  $("#saveBtn").disabled = false;
  $("#clearBtn").disabled = false;
}

/* ===============================
   7) Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø³ + ØªØ³Ø¬ÙŠÙ„ login Ù„Ù„Ø´ÙŠØª
================================ */
$("#startBtn").addEventListener("click", async ()=>{
  const student = $("#studentName").value.trim();
  if(student.length < 6){ toast("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­."); return; }

  const lessonId = $("#lessonSelect").value;
  const lesson = LESSONS.find(l=>l.id===lessonId);
  renderLesson(student, lesson);

  const uid = (crypto?.randomUUID) ? crypto.randomUUID() : String(Date.now());

  await postJSON({
    action:"login",
    siteKey: SITE_KEY,
    uid,
    student,
    lessonId: lesson.id,
    lessonTitle: lesson.title,
    ua: navigator.userAgent
  });

  toast("ØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø±Ø³ âœ…");
});

/* ===============================
   8) Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© + Ø¥Ø±Ø³Ø§Ù„ result Ù„Ù„Ø´ÙŠØª
================================ */
$("#saveBtn").addEventListener("click", async ()=>{
  const student = $("#studentName").value.trim();
  if(!student || !state.lesson){ toast("Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹."); return; }

  const notAnswered = state.answers.some(a=>a.selected===null);
  if(notAnswered){ toast("Ø£Ø¬ÙŠØ¨ÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø«Ù… Ø§Ø¹ØªÙ…Ø¯ÙŠ."); return; }

  const ok = state.points;
  const max = state.lesson.questions.length;
  const bad = max - ok;
  const pct = Math.round((ok/max)*100);

  const uid = (crypto?.randomUUID) ? crypto.randomUUID() : String(Date.now());

  await postJSON({
    action:"result",
    siteKey: SITE_KEY,
    uid,
    student,
    lessonId: state.lesson.id,
    lessonTitle: state.lesson.title,
    ok, bad, pct
  });

  toast(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø´ÙŠØª âœ… (${pct}%)`);
});

/* ===============================
   9) Ù…Ø³Ø­ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ Ù„Ù„Ø·Ø§Ù„Ø¨Ø©
================================ */
$("#clearBtn").addEventListener("click", ()=>{
  const student = $("#studentName").value.trim();
  if(!student || !state.lesson) return;
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ù…Ø³Ø­ Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")) return;
  clearProgress(student, state.lesson.id);
  toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸.");
  renderLesson(student, state.lesson);
});

/* ===============================
   10) Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (stats) â€” ÙŠØ­ØªØ§Ø¬ doGet JSONP
================================ */
function refreshVisits(){
  loadJSONP({action:"stats", siteKey: SITE_KEY}, (data)=>{
    if(data && data.ok) $("#visits").textContent = String(data.totalVisits ?? "â€”");
    else $("#visits").textContent = "â€”";
  });
}
refreshVisits();

// ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© (doPost visit)
postJSON({action:"visit", siteKey: SITE_KEY}).then(()=>setTimeout(refreshVisits, 600));

/* ===============================
   11) Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
================================ */
const adminPanel = $("#adminPanel");
$("#btnAdmin").addEventListener("click", ()=>{
  adminPanel.style.display = "block";
  $("#studentPanel").style.display = "none";
  $("#lessonPanel").style.display = "none";
});
$("#closeAdmin").addEventListener("click", ()=>{
  adminPanel.style.display = "none";
  $("#studentPanel").style.display = "";
  $("#lessonPanel").style.display = "";
});
$("#btnStudent").addEventListener("click", ()=>{
  adminPanel.style.display = "none";
  $("#studentPanel").style.display = "";
  $("#lessonPanel").style.display = "";
});

let activeTab = "results";
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeTab = t.dataset.tab;
  });
});

$("#loadAdmin").addEventListener("click", ()=>{
  const pin = $("#adminPin").value.trim();
  const limit = $("#adminLimit").value || 200;

  loadJSONP({action:"adminData", siteKey:SITE_KEY, pin, limit}, (data)=>{
    if(!data || !data.ok){
      toast("Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.");
      return;
    }
    $("#visits").textContent = String(data.totalVisits ?? "â€”");

    const tableBox = $("#adminTable");
    const rows = (activeTab==="results") ? (data.results||[]) : (data.visits||[]);
    const header = (activeTab==="results") ? (data.resultsHeader||[]) : (data.visitsHeader||[]);

    if(!rows.length){
      tableBox.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>`;
      return;
    }

    const html =
      `<div class="muted" style="margin-bottom:8px">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${rows.length}</div>` +
      `<div style="overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:6px;background:rgba(255,255,255,.04)">
        <table>
          <thead><tr>${header.map(x=>`<th>${x}</th>`).join("")}</tr></thead>
          <tbody>
            ${rows.slice().reverse().map(r=>`<tr>${r.map(c=>`<td>${String(c ?? "")}</td>`).join("")}</tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    tableBox.innerHTML = html;
    toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© âœ…");
  });
});

/* ===============================
   12) ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ø§Ù„Ø¨Ø©
================================ */
(function init(){
  fillLessons();

  const d = new Date();
  $("#today").textContent = d.toLocaleDateString("ar-SA",{weekday:"long",year:"numeric",month:"2-digit",day:"2-digit"});

  const url = new URL(location.href);
  const s = url.searchParams.get("student") || "";
  const l = url.searchParams.get("lesson") || "";

  if(s) $("#studentName").value = s;
  if(l && LESSONS.some(x=>x.id===l)) $("#lessonSelect").value = l;

  updateStudentLink();

  if(s && l){
    const lesson = LESSONS.find(x=>x.id===l);
    renderLesson(s, lesson);
  }
})();
</script>
</body>
</html>
